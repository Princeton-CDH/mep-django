
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>mep.books.models &#8212; Mapping Expatriate Paris - Django 0.19.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mep.books.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">parasolr.indexing</span> <span class="k">import</span> <span class="n">Indexable</span>
<span class="kn">import</span> <span class="nn">rdflib</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">mep.common.models</span> <span class="k">import</span> <span class="n">Named</span><span class="p">,</span> <span class="n">Notable</span>
<span class="kn">from</span> <span class="nn">mep.common.validators</span> <span class="k">import</span> <span class="n">verify_latlon</span>
<span class="kn">from</span> <span class="nn">mep.people.models</span> <span class="k">import</span> <span class="n">Person</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="PublisherPlace"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.PublisherPlace">[docs]</a><span class="k">class</span> <span class="nc">PublisherPlace</span><span class="p">(</span><span class="n">Named</span><span class="p">,</span> <span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Model for place where publishers are located&#39;&#39;&#39;</span>
    <span class="c1"># NOTE: Using decimal field here to set precision on the head</span>
    <span class="c1"># FloatField uses float, which can introduce unexpected rounding.</span>
    <span class="c1"># This would let us have measurements down to the tree level, if necessary</span>

    <span class="c1"># QUESTION: Do we want to add a Geonames ID for this?</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span>
        <span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">decimal_places</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">verify_latlon</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span>
        <span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">decimal_places</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">verify_latlon</span><span class="p">]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="Publisher"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Publisher">[docs]</a><span class="k">class</span> <span class="nc">Publisher</span><span class="p">(</span><span class="n">Named</span><span class="p">,</span> <span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Model for publishers&#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="Format"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Format">[docs]</a><span class="k">class</span> <span class="nc">Format</span><span class="p">(</span><span class="n">Named</span><span class="p">,</span> <span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Format of items in the library (book, periodical, etc)&#39;&#39;&#39;</span>
    <span class="c1">#: linked data URI for the format</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Format or type URI&quot;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Genre"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Genre">[docs]</a><span class="k">class</span> <span class="nc">Genre</span><span class="p">(</span><span class="n">Named</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Genres of items from OCLC&#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="Subject"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Subject">[docs]</a><span class="k">class</span> <span class="nc">Subject</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Linked data subjects for describing :class:`Item`&#39;&#39;&#39;</span>

    <span class="c1">#: name/label for the subject (required but not required unique)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="c1">#: linked data URI for the subject</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Subject URI&quot;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: rdf type for the subject</span>
    <span class="n">rdf_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="s2">&quot;RDF Type&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Subject </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Subject.create_from_uri"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Subject.create_from_uri">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize a new :class:`Subject` from a URI. Loads the URI</span>
<span class="sd">        as an :class:`rdflib.Graph` in order to pull the preferred label</span>
<span class="sd">        and RDF type for the URI.&#39;&#39;&#39;</span>

        <span class="c1"># as for OCLC code, using requests to load RDF content</span>
        <span class="c1"># for more fine-grained control and fewer errors for batch work,</span>
        <span class="c1"># and current SSL support (i.e. for VIAF)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">rdflib</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">request_uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="n">uriref</span> <span class="o">=</span> <span class="n">rdflib</span><span class="o">.</span><span class="n">URIRef</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="c1"># worldcat FAST URIs don&#39;t support content negotation,</span>
        <span class="c1"># so explicitly request RDF content based on known URL format</span>
        <span class="n">request_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://id.worldcat.org/fast/&#39;</span><span class="p">):</span>
            <span class="n">request_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.rdf.xml&#39;</span> <span class="o">%</span> <span class="n">request_uri</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://id.loc.gov/authorities/&#39;</span><span class="p">):</span>
            <span class="c1"># at least one LOC url is redirecting alternately</span>
            <span class="c1"># to an HTML version and json-ld, so explicitly request json-ld</span>
            <span class="n">request_uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.jsonld&#39;</span> <span class="o">%</span> <span class="n">request_uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">request_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/rdf+xml&#39;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_uri</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">request_headers</span><span class="p">)</span>

        <span class="c1"># exclude html responses, since they can&#39;t be parsed</span>
        <span class="c1"># (some LOC json requests are redirecting to html)</span>
        <span class="c1"># Possibly useful? LoC responses include a X-PrefLabel header,</span>
        <span class="c1"># could just use that (and make type optional)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;text/html&#39;</span><span class="p">):</span>
            <span class="n">parse_opts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># some results return json-ld, and rdflib does not autodetect</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application/ld+json&#39;</span><span class="p">:</span>
                <span class="n">parse_opts</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;json-ld&#39;</span>

            <span class="n">graph</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="o">**</span><span class="n">parse_opts</span><span class="p">)</span>

            <span class="n">label_opts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># viaf records include multiple languages and some records</span>
            <span class="c1"># have language codes for them; try with language filter first</span>
            <span class="k">if</span> <span class="s1">&#39;viaf.org&#39;</span> <span class="ow">in</span> <span class="n">uri</span><span class="p">:</span>
                <span class="n">label_opts</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;en-US&#39;</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">preferredLabel</span><span class="p">(</span><span class="n">uriref</span><span class="p">,</span> <span class="o">**</span><span class="n">label_opts</span><span class="p">)</span>
            <span class="c1"># if no labels were found with language tag, try without</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">preferredLabel</span><span class="p">(</span><span class="n">uriref</span><span class="p">)</span>
            <span class="c1"># if still no labels, bail out</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># preferred label returns a list of predicate, object</span>
            <span class="c1"># use the object for the first result</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rdf_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">uriref</span><span class="p">,</span> <span class="n">rdflib</span><span class="o">.</span><span class="n">RDF</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">Subject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                          <span class="n">rdf_type</span><span class="o">=</span><span class="n">rdf_type</span><span class="p">)</span>

        <span class="c1"># if the request failed or was not usable, log the error</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error creating Subject for </span><span class="si">%s</span><span class="s1"> (response </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                       <span class="n">uri</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Work"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work">[docs]</a><span class="k">class</span> <span class="nc">Work</span><span class="p">(</span><span class="n">Notable</span><span class="p">,</span> <span class="n">Indexable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Work record for an item that circulated in the library or was</span>
<span class="sd">    other referenced in library activities.&#39;&#39;&#39;</span>

    <span class="c1">#: mep id from stub records imported from xml</span>
    <span class="n">mep_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;MEP ID&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># NOTE: mep_id has null=true so we can enforce unique constraint but</span>
    <span class="c1"># allow for items with no mep id</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Title of the work in English&#39;</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Date of Publication&#39;</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Work URI&#39;</span><span class="p">,</span>
                          <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Linked data URI for this work&quot;</span><span class="p">)</span>
    <span class="n">edition_uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Edition URI&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Linked data URI for this edition, if known&quot;</span><span class="p">)</span>
    <span class="n">ebook_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;eBook URL&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Link to a webpage where one or more ebook versions can be </span><span class="se">\</span>
<span class="s1">            downloaded, e.g. Project Gutenberg page for this item&#39;</span><span class="p">)</span>
    <span class="n">work_format</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Format</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Format&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Format, e.g. book or periodical&#39;</span><span class="p">)</span>

    <span class="c1">#: update timestamp</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># direct access to all creator persons, using Creator as through model</span>
    <span class="n">creators</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;Creator&#39;</span><span class="p">)</span>

    <span class="c1">#: optional genres, from OCLC record</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Genre</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Genre(s) from OCLC record&#39;</span><span class="p">)</span>
    <span class="c1">#: optional subjects, from OCLC record</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Subject</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: a field for notes publicly displayed on the website</span>
    <span class="n">public_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Notes for display on the public website&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Work.save"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># override save to ensure mep ID is None rather than empty string</span>
        <span class="c1"># if not set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mep_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mep_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Work</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># provide pk for easy lookup and string for recognition</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Work pk:</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">or</span> <span class="s1">&#39;??&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">year_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="n">year_str</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span>
        <span class="n">str_value</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">year_str</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">str_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">str_value</span>
        <span class="k">return</span> <span class="s1">&#39;(No title, year)&#39;</span>

<div class="viewcode-block" id="Work.creator_by_type"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.creator_by_type">[docs]</a>    <span class="k">def</span> <span class="nf">creator_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">creator_type</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return work creators of a single type, e.g. author&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creators</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator__creator_type__name</span><span class="o">=</span><span class="n">creator_type</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">authors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;work creators with type author&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_by_type</span><span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Work.author_list"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.author_list">[docs]</a>    <span class="k">def</span> <span class="nf">author_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;semicolon separated list of author names&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">auth</span><span class="p">)</span> <span class="k">for</span> <span class="n">auth</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">])</span></div>
    <span class="n">author_list</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="s1">&#39;Authors&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">editors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;work creators with type editor&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_by_type</span><span class="p">(</span><span class="s1">&#39;Editor&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">translators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;work creators with type translator&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_by_type</span><span class="p">(</span><span class="s1">&#39;Translator&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Number of events of any kind associated with this work.&#39;&#39;&#39;</span>
        <span class="c1"># use database annotation if present; otherwise use queryset</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;event__count&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">borrow_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Number of times this work was borrowed.&#39;&#39;&#39;</span>
        <span class="c1"># use database annotation if present; otherwise use queryset</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;event__borrow__count&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">borrow__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purchase_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Number of times this work was purchased.&#39;&#39;&#39;</span>
        <span class="c1"># use database annotation if present; otherwise use queryset</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;event__purchase__count&#39;</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">purchase__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

<div class="viewcode-block" id="Work.admin_url"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.admin_url">[docs]</a>    <span class="k">def</span> <span class="nf">admin_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;URL to edit this record in the admin site&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;admin:books_work_change&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">])</span></div>
    <span class="n">admin_url</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="s1">&#39;Admin Link&#39;</span>

<div class="viewcode-block" id="Work.has_uri"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.has_uri">[docs]</a>    <span class="k">def</span> <span class="nf">has_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Is the URI is set for this work?&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span></div>
    <span class="n">has_uri</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">has_uri</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;uri&#39;</span>

<div class="viewcode-block" id="Work.subject_list"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.subject_list">[docs]</a>    <span class="k">def</span> <span class="nf">subject_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;semicolon separated list of subject names&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">subj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>

<div class="viewcode-block" id="Work.genre_list"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.genre_list">[docs]</a>    <span class="k">def</span> <span class="nf">genre_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;semicolon separated list of genres&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">genre</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span></div>

<div class="viewcode-block" id="Work.format"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;format of this work if known (e.g. book or periodical)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_format</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_format</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="Work.index_data"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.index_data">[docs]</a>    <span class="k">def</span> <span class="nf">index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;data for indexing in Solr&#39;&#39;&#39;</span>

        <span class="n">index_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">index_data</span><span class="p">()</span>

        <span class="n">index_data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;title_s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="c1"># include pk for now for item detail url</span>
            <span class="s1">&#39;pk_i&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="s1">&#39;authors_t&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authors</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;editors_t&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;translators_t&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">translators</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">translators</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;pub_date_i&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">index_data</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_known_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;date of the earliest known interaction for this item&#39;&#39;&#39;</span>

        <span class="c1"># search for the earliest start date, excluding any borrow</span>
        <span class="c1"># or purchase events with unknown years</span>
        <span class="n">first_event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">start_date__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">borrow__start_date_precision__knownyear</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">purchase__start_date_precision__knownyear</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">first_event</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">first_event</span><span class="o">.</span><span class="n">start_date</span>

<div class="viewcode-block" id="Work.populate_from_worldcat"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Work.populate_from_worldcat">[docs]</a>    <span class="k">def</span> <span class="nf">populate_from_worldcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worldcat_entity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set work URI, edition URI, genre, item type, and subjects</span>
<span class="sd">        based on a WorldCat record.&#39;&#39;&#39;</span>

        <span class="c1"># work URI apparently not available in all cases; set to</span>
        <span class="c1"># empty string instead of None/null</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">work_uri</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edition_uri</span> <span class="o">=</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">item_uri</span>

        <span class="c1"># add associations for genres, creating if necessary</span>
        <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">genres</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Genre</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">genre</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># types will be prepopulated to work with OCLC search results</span>
        <span class="c1"># (predominantly books and periodicals), but in future</span>
        <span class="c1"># we may need a method to create format from uri as for subjects</span>
        <span class="k">if</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">item_type</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;entity item type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">item_type</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_format</span> <span class="o">=</span> <span class="n">Format</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">uri</span><span class="o">=</span><span class="n">worldcat_entity</span><span class="o">.</span><span class="n">item_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unexpected item type </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">item_type</span><span class="p">)</span>

        <span class="n">subject_uris</span> <span class="o">=</span> <span class="n">worldcat_entity</span><span class="o">.</span><span class="n">subjects</span>
        <span class="k">if</span> <span class="n">subject_uris</span><span class="p">:</span>
            <span class="c1"># find existing subjects already in the database</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Subject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">uri__in</span><span class="o">=</span><span class="n">subject_uris</span><span class="p">))</span>
            <span class="c1"># create any new subjects that don&#39;t already exist</span>
            <span class="n">new_subject_uris</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">subject_uris</span><span class="p">)</span> <span class="o">-</span> \
                <span class="nb">set</span><span class="p">(</span><span class="n">subj</span><span class="o">.</span><span class="n">uri</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subject_uri</span> <span class="ow">in</span> <span class="n">new_subject_uris</span><span class="p">:</span>
                <span class="c1"># try to create the subject</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="n">Subject</span><span class="o">.</span><span class="n">create_from_uri</span><span class="p">(</span><span class="n">subject_uri</span><span class="p">)</span>
                <span class="c1"># if successful, add to the list</span>
                <span class="k">if</span> <span class="n">subject</span><span class="p">:</span>
                    <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
            <span class="c1"># set subjects on this item (replacing any previously set)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Edition"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Edition">[docs]</a><span class="k">class</span> <span class="nc">Edition</span><span class="p">(</span><span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A specific known edition of a :class:`Work` that circulated.&#39;&#39;&#39;</span>

    <span class="n">work</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Work</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Generic Work associated with this edition.&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Title of this edition, if different from associated work&#39;</span><span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Date of Publication for this edition&#39;</span><span class="p">)</span>
    <span class="n">season</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">edition</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;URI&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Linked data URI for this edition, if known&quot;</span><span class="p">)</span>

    <span class="c1">#: update timestamp</span>
    <span class="n">updated_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># direct access to all creator persons, using Creator as through model</span>
    <span class="n">creators</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Person</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;EditionCreator&#39;</span><span class="p">)</span>

    <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pub_places</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">PublisherPlace</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Places of Publication&quot;</span><span class="p">)</span>

    <span class="c1"># language model foreign key may be added in future</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># provide pk for easy lookup and string for recognition</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Edition pk:</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">or</span> <span class="s1">&#39;??&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># simple string representation</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">title</span> <span class="ow">or</span> <span class="s1">&#39;??&#39;</span><span class="p">,</span>
            <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="o">.</span><span class="n">year</span> <span class="ow">or</span> <span class="s1">&#39;??&#39;</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vol. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;no. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">)</span>
        <span class="c1"># include edition?</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="CreatorType"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.CreatorType">[docs]</a><span class="k">class</span> <span class="nc">CreatorType</span><span class="p">(</span><span class="n">Named</span><span class="p">,</span> <span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Type of creator role a person can have in relation to a work;</span>
<span class="sd">    author, editor, translator, etc.&#39;&#39;&#39;</span></div>


<div class="viewcode-block" id="Creator"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.Creator">[docs]</a><span class="k">class</span> <span class="nc">Creator</span><span class="p">(</span><span class="n">Notable</span><span class="p">):</span>
    <span class="n">creator_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">CreatorType</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span>
    <span class="n">work</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">)</span></div>


<div class="viewcode-block" id="EditionCreator"><a class="viewcode-back" href="../../../codedocs.html#mep.books.models.EditionCreator">[docs]</a><span class="k">class</span> <span class="nc">EditionCreator</span><span class="p">(</span><span class="n">Notable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creator specific to an :class:`Edition` of a :class:`Work`.&#39;&#39;&#39;</span>

    <span class="n">creator_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">CreatorType</span><span class="p">)</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span>
    <span class="n">edition</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Edition</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;String representation: person, creator type, edition.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edition</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Mapping Expatriate Paris - Django</a></h1>



<p class="blurb">Django web application for "Mapping Expatriate Paris" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=mep-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/Princeton-CDH/mep-django">
    <img
        alt="https://secure.travis-ci.org/Princeton-CDH/mep-django.svg?branch=master"
        src="https://secure.travis-ci.org/Princeton-CDH/mep-django.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/mep-django">
    <img
    alt="https://codecov.io/github/Princeton-CDH/mep-django/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/mep-django/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Trustees of Princeton University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>