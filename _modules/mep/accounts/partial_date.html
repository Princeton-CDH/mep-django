
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>mep.accounts.partial_date &#8212; mep-django 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mep.accounts.partial_date</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="k">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="k">import</span> <span class="n">RegexValidator</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">flags</span> <span class="k">import</span> <span class="n">Flags</span>


<div class="viewcode-block" id="DatePrecision"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.DatePrecision">[docs]</a><span class="k">class</span> <span class="nc">DatePrecision</span><span class="p">(</span><span class="n">Flags</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Flag class to indicate which parts of a date are known.&#39;&#39;&#39;</span>
    <span class="n">year</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">month</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">day</span> <span class="o">=</span> <span class="p">()</span></div>


<div class="viewcode-block" id="DatePrecisionField"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.DatePrecisionField">[docs]</a><span class="k">class</span> <span class="nc">DatePrecisionField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Integer representation of a :class:`DatePrecision`.&#39;&#39;&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Integer representation of DatePrecision flags.&#39;</span>

<div class="viewcode-block" id="DatePrecisionField.to_python"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.DatePrecisionField.to_python">[docs]</a>    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert integer to :class`DatePrecision` if set&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">DatePrecision</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DatePrecisionField.from_db_value"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.DatePrecisionField.from_db_value">[docs]</a>    <span class="k">def</span> <span class="nf">from_db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert values returned from database to :class:`DatePrecision`</span>
<span class="sd">        using :meth:`to_python`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="DatePrecisionField.value_to_string"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.DatePrecisionField.value_to_string">[docs]</a>    <span class="k">def</span> <span class="nf">value_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Customize string value for JSON serialization&#39;&#39;&#39;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_from_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c1"># return as integer rather than string representation of the flags</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PartialDate"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDate">[docs]</a><span class="k">class</span> <span class="nc">PartialDate</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Descriptor that gets and sets a related :class:`datetime.date` and</span>
<span class="sd">    :class:`DatePrecision` from partial date strings, e.g. --05-02.&#39;&#39;&#39;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Partial date generated from date and date precision flags&#39;</span>

    <span class="n">partial_date_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(?P&lt;year&gt;\d</span><span class="si">{4}</span><span class="s1">|-)?(?:-(?P&lt;month&gt;[01]\d))?(?:-(?P&lt;day&gt;[0-3]\d))?$&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_field</span><span class="p">,</span> <span class="n">date_precision_field</span><span class="p">,</span> <span class="n">unknown_year</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span> <span class="o">=</span> <span class="n">date_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_precision_field</span> <span class="o">=</span> <span class="n">date_precision_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unknown_year</span> <span class="o">=</span> <span class="n">unknown_year</span>

        <span class="c1"># set attributes for display/sort in django admin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="n">date_field</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use :meth:`date_format` to transform a  :class:`datetime.date` and</span>
<span class="sd">        :class:`DatePrecision` to a partial date string. If the date doesn&#39;t</span>
<span class="sd">        exist yet, return None.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">date_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_val</span><span class="p">:</span>
            <span class="n">date_precision_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_precision_field</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">date_val</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_format</span><span class="p">(</span><span class="n">date_precision_val</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Call :meth:`parse_date` to parse a partial date and set the</span>
<span class="sd">        :class:`datetime.date` and :class:`DatePrecision`. If a falsy value was</span>
<span class="sd">        passed, set them both to None.&#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">date_val</span><span class="p">,</span> <span class="n">date_precision_val</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_field</span><span class="p">,</span> <span class="n">date_val</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_precision_field</span><span class="p">,</span> <span class="n">date_precision_val</span><span class="p">)</span>

<div class="viewcode-block" id="PartialDate.date_format"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDate.date_format">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">date_format</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a format string for use with :meth:`datetime.date.strftime`</span>
<span class="sd">        to output a date with the appropriate precision&#39;&#39;&#39;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Handle NULL as indicating full date precision</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>

        <span class="c1"># cast integer to date precision to check flags</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">DatePrecision</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># If the date was not set, this value will be defaulted to no flags,</span>
        <span class="c1"># which is a boolean falsy, i.e. 0., so return no date.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if no year, indicate with --</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;%m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># this is potentially ambiguous in some cases, but those cases</span>
        <span class="c1"># may not be meaningful anyway</span>
        <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>

<div class="viewcode-block" id="PartialDate.parse_date"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDate.parse_date">[docs]</a>    <span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse a partial date string and return a :class:`datetime.date`</span>
<span class="sd">        and precision value.&#39;&#39;&#39;</span>
        <span class="c1"># partial date parsing adapted in part from django_partial_date</span>
        <span class="c1"># https://github.com/ktowen/django_partial_date</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_date_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">match_info</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>

            <span class="c1"># turn matched values into numbers for initializing date object</span>
            <span class="n">date_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">date_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">match_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">date_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">date_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span> <span class="c1"># value was None or &#39;-&#39;</span>
                    <span class="n">date_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_year</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="c1"># error if the regex matched but got an unusable set of date parts</span>
            <span class="k">if</span> <span class="n">date_parts</span> <span class="ow">in</span> <span class="p">([</span><span class="s1">&#39;day&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; is not a recognized date.&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># determine known date parts based on regex match values</span>
            <span class="c1"># and initialize pecision flags accordingly</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">DatePrecision</span><span class="o">.</span><span class="n">from_simple_str</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">date_parts</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="o">**</span><span class="n">date_values</span><span class="p">),</span> <span class="n">precision</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; is not a recognized date.&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PartialDateMixin"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDateMixin">[docs]</a><span class="k">class</span> <span class="nc">PartialDateMixin</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Mixin to add fields for partial start and end dates to a model using</span>
<span class="sd">    :class:`DatePrecisionField` and :class:`PartialDate`.&#39;&#39;&#39;</span>
    <span class="n">UNKNOWN_YEAR</span> <span class="o">=</span> <span class="mi">1900</span>

    <span class="n">start_date_precision</span> <span class="o">=</span> <span class="n">DatePrecisionField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">end_date_precision</span> <span class="o">=</span> <span class="n">DatePrecisionField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">partial_start_date</span> <span class="o">=</span> <span class="n">PartialDate</span><span class="p">(</span>
        <span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="s1">&#39;start_date_precision&#39;</span><span class="p">,</span> <span class="n">UNKNOWN_YEAR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;start date&#39;</span><span class="p">)</span>
    <span class="n">partial_end_date</span> <span class="o">=</span> <span class="n">PartialDate</span><span class="p">(</span>
        <span class="s1">&#39;end_date&#39;</span><span class="p">,</span> <span class="s1">&#39;end_date_precision&#39;</span><span class="p">,</span> <span class="n">UNKNOWN_YEAR</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;end date&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PartialDateMixin.calculate_date"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDateMixin.calculate_date">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">dateval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">earliest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate end or start date based on a single value in a</span>
<span class="sd">        supported partial date form or based on earliest/latest datetime.&#39;&#39;&#39;</span>

        <span class="c1"># kind must be either start_date or end_date</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="s1">&#39;end_date&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># if there is a single date value, use partial date to parse it</span>
        <span class="c1"># and set date precision</span>
        <span class="k">if</span> <span class="n">dateval</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;partial_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">,</span> <span class="n">dateval</span><span class="p">)</span>
            <span class="c1"># special case:</span>
            <span class="c1"># 1900 dates were used to indicate unknown year; book store didn&#39;t</span>
            <span class="c1"># open until 1919, so any year before that should be marked unknown</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">1919</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_precision&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">,</span>
                        <span class="n">DatePrecision</span><span class="o">.</span><span class="n">month</span> <span class="o">|</span> <span class="n">DatePrecision</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>

        <span class="c1"># no exact date, but earliest/latest possible dates</span>
        <span class="k">elif</span> <span class="n">earliest</span> <span class="ow">and</span> <span class="n">latest</span><span class="p">:</span>
            <span class="c1"># store earliest datetime</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">earliest</span><span class="p">)</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">DatePrecision</span><span class="p">()</span>
            <span class="c1"># calculate the precision based on values in common</span>
            <span class="k">if</span> <span class="n">earliest</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">latest</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">|=</span> <span class="n">DatePrecision</span><span class="o">.</span><span class="n">year</span>
            <span class="k">if</span> <span class="n">earliest</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">latest</span><span class="o">.</span><span class="n">month</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">|=</span> <span class="n">DatePrecision</span><span class="o">.</span><span class="n">month</span>
            <span class="k">if</span> <span class="n">earliest</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">latest</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
                <span class="n">precision</span> <span class="o">|=</span> <span class="n">DatePrecision</span><span class="o">.</span><span class="n">day</span>

            <span class="c1"># store the precision</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_precision&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Borrowing event date range as string, using partial dates.</span>
<span class="sd">        Returns a single date in partial date format if both dates are</span>
<span class="sd">        set to the same date. Uses &quot;??&quot; for unset dates,</span>
<span class="sd">        and returns in format start/end.&#39;&#39;&#39;</span>

        <span class="c1"># NOTE: this is the same logic as the Event date range method,</span>
        <span class="c1"># just substituting partial start and end dates and dropping the</span>
        <span class="c1"># isoformat method call.</span>

        <span class="c1"># if both dates are set and the same, return a single date</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_start_date</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_end_date</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">partial_start_date</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_end_date</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_start_date</span>

        <span class="c1"># otherwise, use both dates with ?? to indicate unknown date</span>
        <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dt</span> <span class="k">if</span> <span class="n">dt</span> <span class="k">else</span> <span class="s1">&#39;??&#39;</span>
                         <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">partial_start_date</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">partial_end_date</span><span class="p">]])</span></div>



<div class="viewcode-block" id="PartialDateFormMixin"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDateFormMixin">[docs]</a><span class="k">class</span> <span class="nc">PartialDateFormMixin</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Provides form validation and setting for models that inherit from</span>
<span class="sd">    :class:`mep.accounts.models.PartialDateMixin`.&#39;&#39;&#39;</span>
    <span class="n">partial_date_validator</span> <span class="o">=</span> <span class="n">RegexValidator</span><span class="p">(</span>
        <span class="n">regex</span><span class="o">=</span><span class="n">PartialDate</span><span class="o">.</span><span class="n">partial_date_re</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Value is not a recognized date.&quot;</span>
    <span class="p">)</span>
    <span class="n">partial_date_help_text</span> <span class="o">=</span> <span class="s2">&quot;Enter as much of the date as known, in any of the </span><span class="se">\</span>
<span class="s2">        following formats: yyyy, yyyy-mm, yyyy-mm-dd, --mm-dd&quot;</span>
    <span class="n">partial_start_date</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">partial_date_validator</span><span class="p">],</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="n">partial_date_help_text</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Start date&quot;</span><span class="p">)</span>
    <span class="n">partial_end_date</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">partial_date_validator</span><span class="p">],</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="n">partial_date_help_text</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;End date&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PartialDateFormMixin.get_initial_for_field"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDateFormMixin.get_initial_for_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_initial_for_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;partial_start_date&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">partial_start_date</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;partial_end_date&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">partial_end_date</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_initial_for_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="PartialDateFormMixin.clean"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.PartialDateFormMixin.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse partial dates and save them on form submission.&#39;&#39;&#39;</span>
        <span class="n">cleaned_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">partial_start_date</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;partial_start_date&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">partial_end_date</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;partial_end_date&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">verr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;Date validation error: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">verr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cleaned_data</span></div></div>


<div class="viewcode-block" id="KnownYear"><a class="viewcode-back" href="../../../codedocs.html#mep.accounts.partial_date.KnownYear">[docs]</a><span class="nd">@models</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">register_lookup</span>
<span class="k">class</span> <span class="nc">KnownYear</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Custom lookup to filter on known year in `:class:`DatePrecisionField`&#39;&#39;&#39;</span>
    <span class="n">lookup_name</span> <span class="o">=</span> <span class="s1">&#39;knownyear&#39;</span>
    <span class="n">prepare_rhs</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="n">lhs</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs</span><span class="p">)</span>

        <span class="n">bit_compare</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &amp; </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">DatePrecision</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
        <span class="c1"># if true (year is known), precision should be null or year bit set</span>
        <span class="c1"># (has to include null check since field is currently configured</span>
        <span class="c1"># to allow null rather than defaulting to full precision)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IS NULL OR </span><span class="si">%s</span><span class="s2"> != 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">bit_compare</span><span class="p">),</span> <span class="n">params</span>

        <span class="c1"># for false (year is unknown), bit should not be set</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = 0&quot;</span> <span class="o">%</span> <span class="n">bit_compare</span><span class="p">,</span> <span class="n">params</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">mep-django</a></h1>



<p class="blurb">Django web application for Shakespeare & Company Project (Formerly Mapping Expatriate Paris)</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=mep-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/Princeton-CDH/mep-django">
    <img
        alt="https://secure.travis-ci.org/Princeton-CDH/mep-django.svg?branch=master"
        src="https://secure.travis-ci.org/Princeton-CDH/mep-django.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/mep-django">
    <img
    alt="https://codecov.io/github/Princeton-CDH/mep-django/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/mep-django/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Trustees of Princeton University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>